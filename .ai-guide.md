# AI Agent Development Guide

## Stack

Next.js 16 · TypeScript · Tailwind v4 · shadcn/ui · React Query · Lucide Icons · next-themes · nuqs · zustand · nanoid · usehooks-ts  
**Optional**: Supabase (can be removed if not needed)

## Structure

```
app/
  layout.tsx         → Root layout with QueryProvider & Toaster
  page.tsx           → Homepage
  loading.tsx        → Global loading fallback
  error.tsx          → Global error boundary
  not-found.tsx      → 404 page
  api/               → API routes (create as needed)
components/
  ui/                → shadcn/ui (auto-generated, DO NOT manually edit)
  layout/            → Container, PageHeader
  loading-skeleton.tsx → CardSkeleton, TableSkeleton, FormSkeleton
  theme-switcher.tsx → Theme toggle dropdown
lib/
  supabase/          → [OPTIONAL] Remove if not using Supabase
    server.ts        → Server-side client
    client.ts        → Client-side client
    middleware.ts    → Session handling
  providers/
    query-provider.tsx → React Query setup
    theme-provider.tsx → next-themes setup
  stores/
    example-store.ts → Zustand store examples
  types/
    database.ts      → Database types (Supabase or custom)
    index.ts         → ActionResult & shared types
  utils/
    dates.ts         → Date formatting
    id.ts            → ID generation (nanoid)
    index.ts         → Utils barrel export
  utils.ts           → cn() utility
  env.ts             → Environment validation
hooks/
  query-hooks-template.ts → React Query hooks template
actions/             → Server actions (create as needed)
middleware.ts        → Next.js middleware
scripts/             → Utility scripts
```

## TypeScript Rules

- **Strict mode** - always type params & returns
- **Interfaces** for objects, **types** for unions/utilities
- **Never use `any`** - use `unknown` if needed
- **ActionResult**: `{ success: boolean, data?: T, error?: string }`

## Available Scripts

```bash
npm run dev                  # Start dev server
npm run build                # Production build
npm run type-check           # Check TypeScript errors
npm run lint                 # Run ESLint
npm run lint:fix             # Fix ESLint errors
npm run validate             # Run type-check + lint

# Supabase (only if using)
PROJECT_ID=xxx npm run types:generate  # Generate DB types
npm run db:types             # Same as above

# Environment
npm run setup:env            # Create .env.local from env.example
npm run check:env            # Validate env vars

# Cleanup
npm run clean                # Clear .next cache
npm run clean:all            # Remove node_modules + .next
npm run reinstall            # Full reinstall
```

## React Patterns

### Server Components (Default - Fastest)

```typescript
export default async function Page() {
  const data = await fetchData()
  return <div>{data.title}</div>
}
```

### Client Components (Only When Needed)

```typescript
'use client'
import { useState } from 'react'

export function Interactive() {
  const [count, setCount] = useState(0)
  return <button onClick={() => setCount(count + 1)}>{count}</button>
}
```

### React Query (Client-Side Data Fetching)

```typescript
"use client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";

export function useItems() {
  return useQuery({
    queryKey: ["items"],
    queryFn: async () => {
      const res = await fetch("/api/items");
      if (!res.ok) throw new Error("Failed to fetch");
      return res.json();
    },
  });
}

export function useCreateItem() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (item: Item) => {
      const res = await fetch("/api/items", {
        method: "POST",
        body: JSON.stringify(item),
      });
      if (!res.ok) throw new Error("Failed");
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["items"] });
    },
  });
}
```

### Server Actions (Mutations)

```typescript
"use server";
import { revalidatePath } from "next/cache";
import type { ActionResult } from "@/lib/types";

export async function createItem(input: Input): Promise<ActionResult<Item>> {
  try {
    if (!input.title?.trim()) {
      return { success: false, error: "Title required" };
    }

    const item = await db.insert(input);

    revalidatePath("/items");
    return { success: true, data: item };
  } catch (error) {
    console.error(error);
    return { success: false, error: "Failed to create item" };
  }
}
```

### Forms with Server Actions

```typescript
'use client'
import { useActionState, useEffect } from 'react'
import { toast } from 'sonner'

export function Form() {
  const [state, formAction, isPending] = useActionState(createItem, null)

  useEffect(() => {
    if (state?.success) toast.success('Created!')
    if (state?.error) toast.error(state.error)
  }, [state])

  return (
    <form action={formAction}>
      <Input name="title" required disabled={isPending} />
      <Button type="submit" disabled={isPending}>
        {isPending ? 'Creating...' : 'Create'}
      </Button>
    </form>
  )
}
```

## Database Access

### With Supabase

**Server (Components/Actions)**:

```typescript
import { createClient } from "@/lib/supabase/server";
const supabase = await createClient();
const { data, error } = await supabase.from("items").select();
```

**Client (Components/Hooks)**:

```typescript
import { createClient } from "@/lib/supabase/client";
const supabase = createClient();
const { data, error } = await supabase.from("items").select();
```

### Without Supabase (API Routes)

**Create API Route** (`app/api/items/route.ts`):

```typescript
import { NextRequest, NextResponse } from "next/server";

export async function GET() {
  const items = await db.query("SELECT * FROM items");
  return NextResponse.json({ data: items });
}

export async function POST(request: NextRequest) {
  const body = await request.json();
  const item = await db.insert(body);
  return NextResponse.json({ data: item }, { status: 201 });
}
```

**Use in Client**:

```typescript
const { data } = useQuery({
  queryKey: ["items"],
  queryFn: async () => {
    const res = await fetch("/api/items");
    return res.json();
  },
});
```

## Using Without Supabase

**Option 1: Just don't configure it**

- Don't set `NEXT_PUBLIC_SUPABASE_URL` or `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- Use API routes (`app/api/`) for data fetching
- Everything else works fine!

**Option 2: Fully remove Supabase**

1. Delete `lib/supabase/` folder
2. Delete Supabase logic from `lib/env.ts`
3. Remove `updateSession` from `middleware.ts`
4. `npm uninstall @supabase/supabase-js @supabase/ssr`
5. Remove from `env.example`

## Available Components & Utils

### Layout Components

```typescript
import { Container, PageHeader } from '@/components/layout'

<Container size="lg">
  <PageHeader
    title="Dashboard"
    description="Overview"
  >
    <Button>Action</Button>
  </PageHeader>
</Container>
```

Container sizes: `sm` (3xl) | `md` (5xl) | `lg` (7xl) | `xl` (1400px) | `full`

### Loading Skeletons

```typescript
import { CardSkeleton, TableSkeleton, FormSkeleton } from '@/components/loading-skeleton'

<Suspense fallback={<CardSkeleton />}>
  <AsyncData />
</Suspense>
```

### Date Utilities

```typescript
import { formatDate, formatDateTime, formatRelativeTime } from "@/lib/utils";

formatDate("2025-12-30"); // "Dec 30, 2025"
formatDateTime("2025-12-30"); // "Dec 30, 2025, 3:45 PM"
formatRelativeTime("2025-12-30"); // "2h ago" or "3d ago"
```

### Toast Notifications

```typescript
import { toast } from "sonner";

toast.success("Success!");
toast.error("Error message");
toast.loading("Processing...");
toast.info("FYI");
toast.promise(promise, {
  loading: "Saving...",
  success: "Saved!",
  error: "Failed to save",
});
```

### Styling with cn()

```typescript
import { cn } from '@/lib/utils'

<div className={cn(
  "px-4 py-2",
  isActive && "bg-blue-500",
  variant === 'large' && "text-lg",
  className
)} />
```

### Theme Switching

```typescript
'use client'
import { useTheme } from 'next-themes'

export function Component() {
  const { theme, setTheme, systemTheme } = useTheme()

  return (
    <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}>
      Toggle: {theme}
    </button>
  )
}
```

**Pre-built component**: Import `<ThemeSwitcher />` from `@/components/theme-switcher`

### Global State (Zustand)

```typescript
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface CounterStore {
  count: number
  increment: () => void
  decrement: () => void
}

export const useCounter = create<CounterStore>()(
  persist(
    (set) => ({
      count: 0,
      increment: () => set((s) => ({ count: s.count + 1 })),
      decrement: () => set((s) => ({ count: s.count - 1 }))
    }),
    { name: 'counter-storage' }
  )
)

export function Component() {
  const { count, increment } = useCounter()
  return <button onClick={increment}>{count}</button>
}
```

See `lib/stores/example-store.ts` for patterns

### URL State (nuqs)

```typescript
'use client'
import { useQueryState, parseAsInteger, parseAsString } from 'nuqs'

export function SearchPage() {
  const [search, setSearch] = useQueryState('q', parseAsString.withDefault(''))
  const [page, setPage] = useQueryState('page', parseAsInteger.withDefault(1))

  return (
    <>
      <input value={search} onChange={(e) => setSearch(e.target.value)} />
      <button onClick={() => setPage(p => p + 1)}>Next Page</button>
    </>
  )
}
```

**Benefits**: Type-safe, syncs with URL, works with back/forward

### ID Generation

```typescript
import { generateId, generateShortId } from "@/lib/utils";

const uniqueId = generateId(); // "V1StGXR8_Z5jdHi6B-myT" (21 chars)
const shortId = generateShortId(); // "V1StGXR8_Z" (10 chars)
```

### Utility Hooks (usehooks-ts)

```typescript
import {
  useLocalStorage,
  useDebounce,
  useMediaQuery,
  useInterval,
  useEventListener,
} from "usehooks-ts";

const [value, setValue] = useLocalStorage("key", "default");
const debouncedValue = useDebounce(searchTerm, 500);
const isMobile = useMediaQuery("(max-width: 768px)");
```

[Full list](https://usehooks-ts.com/)

## shadcn/ui Components

All in `components/ui/` - **DO NOT manually edit**

**Install more**: `npx shadcn@latest add [component-name]`

**Available**: accordion, alert, alert-dialog, avatar, badge, breadcrumb, button, calendar, card, carousel, chart, checkbox, command, dialog, drawer, dropdown-menu, form, input, label, popover, progress, radio-group, scroll-area, select, separator, sheet, sidebar, skeleton, slider, sonner, spinner, switch, table, tabs, textarea, toggle, tooltip

**Usage**:

```typescript
import { Button } from '@/components/ui/button'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Input } from '@/components/ui/input'

<Card>
  <CardHeader>
    <CardTitle>Title</CardTitle>
  </CardHeader>
  <CardContent>
    <Input placeholder="Enter text" />
    <Button>Submit</Button>
  </CardContent>
</Card>
```

## Naming Conventions

- **Components**: `PascalCase.tsx` (UserProfile, DashboardCard)
- **Utils/Hooks**: `camelCase.ts` (formatDate, useItems)
- **Types**: `PascalCase` (User, ActionResult)
- **Constants**: `UPPER_SNAKE_CASE` (MAX_RETRIES, API_URL)
- **Booleans**: `is/has/should` prefix (isLoading, hasAccess, shouldShow)
- **Files**: Match primary export (Button.tsx → export Button)

## Adding Features

### Process

1. **Types** → Define in `lib/types/*.ts`
2. **Data Layer** → Create hooks in `hooks/use-feature.ts` OR API routes in `app/api/feature/`
3. **Components** → Build UI in `components/feature/`
4. **Server Actions** → If needed, create in `actions/feature.ts`
5. **Page** → Create in `app/feature/page.tsx`
6. **Loading/Error** → Add `loading.tsx` and `error.tsx` in route folder

### Example Feature Structure

```
app/dashboard/
  page.tsx
  loading.tsx
  error.tsx
components/dashboard/
  stats-card.tsx
  recent-list.tsx
hooks/
  use-dashboard.ts
lib/types/
  dashboard.ts
actions/
  dashboard.ts (if needed)
```

## Environment Setup

1. **Create env file**: `npm run setup:env`
2. **Add credentials**: Edit `.env.local` (optional if not using Supabase)
3. **Validate**: `npm run check:env`
4. **Start dev**: `npm run dev`

**Supabase vars** (optional - only needed if using Supabase):

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

Project works without these! If not set, Supabase clients will throw clear errors when called.

**Add more vars**: Update `lib/env.ts` with validation

## Type Generation (Supabase Only)

```bash
# Set your project ID
PROJECT_ID=your-project-id npm run types:generate

# Types saved to lib/types/database.ts
```

Update `Database` interface when schema changes.

## Best Practices

✅ **Server Components by default** (faster, less JS)  
✅ **React Query for client data** (caching, optimistic updates)  
✅ **Server Actions for mutations** (type-safe, no API routes needed)  
✅ **Validate all inputs** (server actions, API routes)  
✅ **Use ActionResult pattern** for consistent returns  
✅ **Revalidate paths** after mutations (`revalidatePath`)  
✅ **Proper types** (no `any`)  
✅ **Suspense boundaries** for async components  
✅ **Toast feedback** for user actions  
✅ **Error boundaries** for graceful failures  
✅ **Loading states** for better UX

## Common Mistakes

❌ Using "use client" unnecessarily (use Server Components)  
❌ Fetching in Client Components (use Server Components or React Query)  
❌ Not validating server action inputs (security risk)  
❌ Forgetting revalidatePath after mutations (stale data)  
❌ Using `any` type (loses type safety)  
❌ Not handling loading/error states (bad UX)  
❌ Creating API routes for simple queries (use Server Components)  
❌ Manual className strings (use `cn()` utility)

## Quick Reference

**Imports**: `@/` = root  
**Client state**: useState, Zustand  
**URL state**: nuqs (useQueryState)  
**Server state**: Server Components + Server Actions  
**Forms**: useActionState + Server Actions  
**Styling**: Tailwind + cn()  
**Theme**: next-themes (useTheme)  
**Icons**: Lucide React  
**UI**: shadcn/ui components  
**Toasts**: sonner  
**IDs**: generateId() from lib/utils  
**Hooks**: usehooks-ts  
**Data fetching**: Server Components or React Query

## File Organization

**Group by feature**:

```
components/dashboard/
  stats.tsx
  chart.tsx
  table.tsx
```

**Use barrel exports**:

```typescript
// components/dashboard/index.ts
export { Stats } from "./stats";
export { Chart } from "./chart";

// Usage
import { Stats, Chart } from "@/components/dashboard";
```

**Colocation**: Keep related files together (component + hooks + types)
